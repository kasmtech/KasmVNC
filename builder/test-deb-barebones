#!/bin/bash

set -e

detect_base_image() {
  if [ "$os" = kali ]; then
    BASE_IMAGE=kalilinux/kali-rolling:latest
    return
  fi
  BASE_IMAGE="${os}:${os_codename}"
}

cd "$(dirname "$0")/.."
. ./builder/process_test_options.sh
. ./builder/common.sh
os="${1:-debian}"
os_codename="${2:-buster}"
distro="${os}_${os_codename}"

detect_build_dir
detect_base_image
docker build --build-arg KASMVNC_PACKAGE_DIR="${build_dir}/${os_codename}" \
  --build-arg RUN_TEST="$run_test" \
  --build-arg BASE_IMAGE="$BASE_IMAGE" \
  -t kasmvnctester_barebones_${os}:$os_codename \
  -f builder/dockerfile.${distro}.barebones.deb.test .
echo

detect_interactive
docker run $interactive -p "443:$VNC_PORT" --rm -e "VNC_USER=foo" -e "VNC_PW=foobar" \
  $core_dumps_dir_volume_option \
  -e "VNC_PORT=$VNC_PORT" \
  -e RUN_TEST="$run_test" \
  -e CORE_DUMP_DIR_ON_HOST="$core_dumps_dir_on_host/${distro}" \
  -e CORE_DUMP_DIR_INSIDE_CONTAINER="${core_dumps_dir_inside_container}/${distro}" \
  --cap-add=SYS_PTRACE \
  --cap-add=SYS_RESOURCE \
  --ulimit core=-1 \
  $entrypoint_executable \
  kasmvnctester_barebones_${os}:$os_codename \
  $entrypoint_args
